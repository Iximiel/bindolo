<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Landing</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <h1>Hello {{ username|e }}!</h1>
    <p><a href="{{ url_for('index') }}">Back</a></p>

    {% if accepted is defined and not accepted %}
    <div class="notice" role="alert">
        {{ reason|e }}
    </div>
    {% endif %}

    <div id="user-alert" role="status" aria-live="polite"></div>

    <div>
        <input type="checkbox" id="ready-checkbox" />
        <label for="ready-checkbox">Ready</label>
    </div>

    <script>
        const POLL_INTERVAL_MS = 3000;

        // expose username & initial state from server-rendered template
        const USERNAME = {{ username| tojson }};
        const INITIAL_USER_STATE = {{ (user_state |default ('entering'))| tojson }};

        let _initialized = false;

        async function setUserReady() {
            try {
                const res = await fetch("{{ url_for('set_user_ready') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: USERNAME })
                });
                return res.ok;
            } catch (err) {
                console.error('Error setting user state', err);
                return false;
            }
        }

        async function checkGameStatus() {
            try {
                const res = await fetch("{{ url_for('get_users') }}", { cache: 'no-store' });
                if (!res.ok) return;
                const data = await res.json();
                const alertEl = document.getElementById('user-alert');
                const checkbox = document.getElementById('ready-checkbox');

                // enable/disable checkbox depending on whether enough players have joined
                checkbox.disabled = !data.necessary_players;

                // set checked according to initial state only once on first load
                if (!_initialized) {
                    checkbox.checked = INITIAL_USER_STATE === 'ready';
                    _initialized = true;
                }

                if (data.all_ready) {
                    alertEl.textContent = 'All players are READY. Redirecting...';
                    alertEl.style.display = 'block';
                    // brief delay so users see the message before redirect
                    setTimeout(() => { window.location.href = "{{ url_for('play') }}"; }, 700);
                    return;
                } else if (data.necessary_players) {
                    alertEl.textContent = 'Enough players have joined.';
                    alertEl.style.display = 'block';
                } else {
                    alertEl.style.display = 'none';
                }
            } catch (err) {
                console.error('Error checking game status', err);
            }
        }

        // initial check and periodic polling
        checkGameStatus();
        setInterval(checkGameStatus, POLL_INTERVAL_MS);

        // handle checkbox change
        document.getElementById('ready-checkbox').addEventListener('change', async function (e) {
            const checked = e.target.checked;
            if (checked) {
                const ok = await setUserReady();
                if (!ok) {
                    // revert checkbox if update failed
                    e.target.checked = !checked;
                    alert('Failed to update ready state');
                }
            }
        });
    </script>
</body>

</html>