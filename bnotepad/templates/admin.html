<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Admin — Players</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <h1>Bindolo Notepad</h1>
    <p>Stato del server.</p>

    <section>
        <h2>Server</h2>
        <ul id="server-list">
            <li>Stato: <span id="server-state">non disponibile</span>
            </li>
            <li>Parola corrente: <span id="server-word"> - </span>
            </li>
            <li>Accetta Giocatori: <span id="server-started"> sì </span>
            </li>
        </ul>
    </section>

    <section>
        <h2>Giocatori</h2>
        <ul id="players-list">
            <li>Loading…</li>
        </ul>
    </section>

    <script>
        const POLL_INTERVAL_MS = 5000;

        async function loadState() {
            const playerList = document.getElementById('players-list');
            try {
                const res = await fetch("{{ url_for('get_players') }}", { cache: 'no-store' });
                if (res.ok) {
                    const data = await res.json();
                    playerList.innerHTML = '';
                    const users = data.users;
                    const keys = Object.keys(users).sort();
                    if (keys.length === 0) {
                        const li = document.createElement('li');
                        li.textContent = 'No players';
                        playerList.appendChild(li);
                        return;
                    }
                    for (const k of keys) {
                        const li = document.createElement('li');
                        li.textContent = `${k} — ${users[k]}`;
                        playerList.appendChild(li);
                    }
                }
            } catch (err) {
                console.error('Failed loading players', err);
                const li = document.createElement('li');
                li.textContent = 'No players';
                playerList.appendChild(li);
            }
            const serverList = document.getElementById('server-list');
            try {
                const res = await fetch("{{ url_for('get_state') }}", { cache: 'no-store' });
                if (res.ok) {
                    const data = await res.json();
                    const state = data.state;
                    if (state) {
                        document.getElementById('server-state').innerHTML = state;

                    }
                    const word = data.word;
                    if (word) {
                        document.getElementById('server-word').innerHTML = word;
                    } else {
                        document.getElementById('server-word').innerHTML = ' -';
                    }

                    if ("started" in data) {
                        const started = data.started;

                        document.getElementById('server-started').innerHTML = started ? ' no' : ' sì';

                    } else {
                        document.getElementById('server-started').innerHTML = ' -';
                    }
                }
            } catch (err) {
                console.error('Failed loading players', err);
                // const li = document.createElement('li');
                // li.textContent = 'Failed to load server state';
                // serverList.appendChild(li);
            }
        }

        loadState();
        setInterval(loadState, POLL_INTERVAL_MS);
    </script>
</body>

</html>